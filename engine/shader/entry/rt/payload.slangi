/// @file payload.slangi
/// @brief 光线追踪载荷结构体定义（重构版）
///
/// Payload 职责简化：只负责 hit -> raygen 的信息回传
/// 所有 BRDF 计算、throughput 计算、radiance 更新都在 ray gen 中进行

#pragma once
#include "share/pass/rt.slangi"

/// Push Constants 声明（所有 RT 着色器共享）
[[vk::push_constant]]
rt::PushConstants push_const;

/// 路径追踪最大深度
const static uint max_depth = 16;

/// 超过一定数量后，就不再重新计算了
const static uint max_accum_samples = 4096;

/// 材质类型枚举
enum MaterialType : uint
{
    DIFFUSE = 0,     ///< 漫反射材质
    SPECULAR = 1,    ///< 镜面反射材质（delta 路径）
    TRANSPARENT = 2, ///< 透明/折射材质（delta 路径）
    EMISSIVE = 3,    ///< 自发光材质
    NO_HIT = 4, ///< 未命中任何几何体
};

/// 命中信息结构体
/// 包含 hit shader 提取的所有几何和材质信息
struct HitInfo
{
    // ========== 几何信息 ==========
    /// 世界空间命中位置
    float3 position;
    /// 世界空间法线（已根据光线方向翻转）
    float3 normal;
    /// 原始世界空间法线（未翻转，用于判断正反面）
    float3 origin_normal;
    /// 纹理坐标
    float2 uv;

    // ========== 材质参数 ==========
    /// 基础颜色（漫反射颜色）
    float3 base_color;
    /// 金属度
    float metallic;
    /// 粗糙度
    float roughness;
    /// 不透明度（1.0 = 完全不透明）
    float opaque;
    /// 折射率
    float ior;

    // ========== 自发光 ==========
    /// 自发光颜色
    float3 emissive;

    // ========== 材质类型 ==========
    /// 材质类型
    MaterialType material_type;

    /// 是否为 delta 路径（镜面反射或透明折射）
    bool is_delta_path()
    {
        return material_type == MaterialType::SPECULAR ||
            material_type == MaterialType::TRANSPARENT;
    }
};

/// 主光线追踪载荷（重构版）
/// 只负责从 hit shader 向 ray gen 传递命中信息
struct HitPayload
{
    /// 是否命中几何体
    bool hit;
    /// 命中信息（仅当 hit == true 时有效）
    HitInfo info;
    /// 随机数种子
    uint random_seed;
};

/// 阴影光线载荷
struct ShadowMissPayload
{
    bool miss;
};

/// 材质采样载荷（用于 callable shader）
struct MatPayload
{
    uint instance_id;
    uint geometry_id;
    float2 uv;
    float3 out_color;
};
